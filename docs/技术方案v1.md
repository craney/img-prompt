# img-prompt é¡¹ç›®ï¼šClerk åˆ° NextAuth è®¤è¯ç³»ç»Ÿè¿ç§»æŠ¥å‘Š

## é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: img-prompt  
**è¿ç§»æ—¥æœŸ**: 2025-09-10  
**è¿ç§»ç±»å‹**: è®¤è¯ç³»ç»Ÿä» Clerk å®Œå…¨åˆ‡æ¢åˆ° NextAuth  
**é¡¹ç›®æ¶æ„**: Next.js 14 + Monorepo + tRPC + PostgreSQL  

---

## éœ€æ±‚èƒŒæ™¯

### ä¸šåŠ¡éœ€æ±‚
é¡¹ç›®åœ¨ç”Ÿäº§ç¯å¢ƒé‡åˆ°ä¸¤ä¸ªå…³é”®é—®é¢˜éœ€è¦è§£å†³ï¼š
1. æ•°æ®åº“è¿æ¥é”™è¯¯ï¼ˆVercelPostgresError: invalid_connection_stringï¼‰
2. Clerk è®¤è¯ç³»ç»Ÿé…ç½®é—®é¢˜å¯¼è‡´å¼€å‘ç¯å¢ƒæ— æ³•æ­£å¸¸å¯åŠ¨

### æŠ€æœ¯çº¦æŸ
- å¿…é¡»ä¿æŒç°æœ‰é¡¹ç›®æ¶æ„çš„ç¨³å®šæ€§
- ç¡®ä¿ç”Ÿäº§ç¯å¢ƒå’Œå¼€å‘ç¯å¢ƒçš„ä¸€è‡´æ€§
- é™ä½ç¬¬ä¸‰æ–¹æœåŠ¡ä¾èµ–å’Œæˆæœ¬

### ç”¨æˆ·åå¥½
- å…ˆåˆ†æé—®é¢˜å¹¶æä¾›å®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œä¸è¦ç›´æ¥åŠ¨æ‰‹ä¿®æ”¹
- åœ¨ç¡®è®¤æ–¹æ¡ˆåï¼Œä½¿ç”¨"å¯¹ï¼Œæ”¹å§"ä½œä¸ºæ‰§è¡ŒæŒ‡ä»¤
- ä¼˜å…ˆç¡®ä¿æœ¬åœ°ç¯å¢ƒç¨³å®šè¿è¡Œ

---

## é—®é¢˜èƒŒæ™¯

### åˆå§‹é—®é¢˜
é¡¹ç›®åœ¨æ„å»ºå’Œå¼€å‘ç¯å¢ƒå¯åŠ¨æ—¶é‡åˆ°ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

1. **æ•°æ®åº“è¿æ¥é”™è¯¯ (VercelPostgresError)**
   ```
   Error: invalid_connection_string
   ```

2. **Clerk è®¤è¯ç³»ç»Ÿé”™è¯¯**
   ```
   Error: @clerk/clerk-react: The publishableKey passed to Clerk is invalid
   ```

### ç”¨æˆ·éœ€æ±‚
ç”¨æˆ·æ˜ç¡®è¡¨ç¤ºï¼š
- å…ˆåˆ†æé—®é¢˜å¹¶æä¾›è§£å†³æ–¹æ¡ˆï¼Œä¸è¦ç›´æ¥åŠ¨æ‰‹ä¿®æ”¹
- åœ¨ç¡®è®¤æ–¹æ¡ˆåï¼Œä½¿ç”¨"å¯¹ï¼Œæ”¹å§"ä½œä¸ºæ‰§è¡ŒæŒ‡ä»¤
- å¸Œæœ›å®Œå…¨åˆ‡æ¢åˆ° NextAuth è®¤è¯ç³»ç»Ÿ

---

## é—®é¢˜åˆ†æé˜¶æ®µ

### 1. æ•°æ®åº“è¿æ¥é—®é¢˜åˆ†æ

**é—®é¢˜æ ¹æº**:
- ä½¿ç”¨ `@vercel/postgres-kysely` çš„ `createKysely()` å‡½æ•°
- Session Pooler è¿æ¥å­—ç¬¦ä¸²ä¸è¯¥å‡½æ•°ä¸å…¼å®¹
- éœ€è¦ pooled connection ä½†å½“å‰é…ç½®æ— æ³•æ­£ç¡®å¤„ç†

**æ¶‰åŠæ–‡ä»¶**:
- `/packages/db/index.ts`
- `/packages/auth/db.ts`

### 2. Clerk è®¤è¯é—®é¢˜åˆ†æ

**é—®é¢˜æ ¹æº**:
- å¼€å‘ç¯å¢ƒä¸­ Clerk å¯†é’¥è®¾ç½®ä¸ºå ä½ç¬¦å€¼ '1'
- ClerkProvider åœ¨å¤šä¸ªç»„ä»¶ä¸­è¢«å¼•ç”¨
- ä¸­é—´ä»¶å’Œ tRPC é…ç½®ä¾èµ– Clerk

**æ¶‰åŠç»„ä»¶**:
- Layout ç»„ä»¶ä¸­çš„ ClerkProvider
- è®¤è¯ç›¸å…³ç»„ä»¶ (SignInClerkModal, UserClerkAuthForm)
- ä¸­é—´ä»¶é…ç½®
- tRPC è®¤è¯ä¸Šä¸‹æ–‡

---

## è§£å†³æ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆä¸€ï¼šä¿®å¤ Clerk é…ç½® (è¢«æ‹’ç»)
- ä½¿ç”¨ Direct connection å­—ç¬¦ä¸²
- é…ç½®æœ‰æ•ˆçš„ Clerk å¯†é’¥
- **ç”¨æˆ·åé¦ˆ**: "1ä¸è¡Œï¼Œä¹‹å‰è¯•è¿‡äº†"

### æ–¹æ¡ˆäºŒï¼šä¿®æ”¹æ•°æ®åº“é…ç½® (æˆåŠŸ)
- ä½¿ç”¨ `@vercel/postgres` çš„ `createClient()`
- é…åˆ Kysely çš„ `PostgresDialect`
- ä¿æŒ Session Pooler è¿æ¥

### æ–¹æ¡ˆä¸‰ï¼šå®Œå…¨åˆ‡æ¢åˆ° NextAuth (æœ€ç»ˆé€‰æ‹©)
- ç§»é™¤æ‰€æœ‰ Clerk ä¾èµ–
- å®ç° NextAuth è®¤è¯æµç¨‹
- æ›´æ–°æ‰€æœ‰ç›¸å…³ç»„ä»¶å’Œé…ç½®

---

## æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©è¿‡ç¨‹
1. **æ–¹æ¡ˆä¸€**ï¼šä¿®å¤ Clerk é…ç½® â†’ ç”¨æˆ·åé¦ˆå·²å°è¯•ï¼Œæ•ˆæœä¸ä½³
2. **æ–¹æ¡ˆäºŒ**ï¼šä¿®æ”¹æ•°æ®åº“é…ç½® â†’ æˆåŠŸè§£å†³æ„å»ºé—®é¢˜
3. **æ–¹æ¡ˆä¸‰**ï¼šå®Œå…¨åˆ‡æ¢ NextAuth â†’ å½»åº•è§£å†³è®¤è¯é—®é¢˜

### æœ€ç»ˆæŠ€æœ¯æ ˆå˜æ›´
```diff
è®¤è¯ç³»ç»Ÿ:
- Clerk Authentication
+ NextAuth.js

æ•°æ®åº“è¿æ¥:
- @vercel/postgres-kysely
+ @vercel/postgres + Kysely PostgresDialect

è®¤è¯æä¾›å•†:
+ GitHub OAuth
+ Email Magic Link
```

### æ ¸å¿ƒç»„ä»¶æ¶æ„å˜æ›´

#### 1. æ•°æ®åº“é…ç½®é‡æ„

**æ–‡ä»¶**ï¼š`packages/db/index.ts`
```typescript
// ä¿®æ”¹å‰
import { createKysely } from "@vercel/postgres-kysely";
export const db = createKysely<DB>();

// ä¿®æ”¹å
import { createClient } from "@vercel/postgres";
import { Kysely, PostgresDialect } from "kysely";

const client = createClient({
  connectionString: process.env.POSTGRES_URL,
});

export const db = new Kysely<DB>({
  dialect: new PostgresDialect({
    pool: client as any,
  }),
});
```

**æ–‡ä»¶**ï¼š`packages/auth/db.ts`
- åº”ç”¨ç›¸åŒçš„æ•°æ®åº“è¿æ¥æ¨¡å¼

#### 2. NextAuth é…ç½®å®ç°

**æ–°å¢æ–‡ä»¶**ï¼š`packages/auth/nextauth.ts`
```typescript
import { NextAuthOptions } from "next-auth";
import { KyselyAdapter } from "@auth/kysely-adapter";
import GitHubProvider from "next-auth/providers/github";
import EmailProvider from "next-auth/providers/email";

export const authOptions: NextAuthOptions = {
  session: { strategy: "jwt" },
  pages: { signIn: "/login" },
  adapter: KyselyAdapter(db),
  providers: [
    GitHubProvider({
      clientId: env.GITHUB_CLIENT_ID,
      clientSecret: env.GITHUB_CLIENT_SECRET,
    }),
    EmailProvider({
      sendVerificationRequest: async ({ identifier, url }) => {
        // Resend é‚®ä»¶å‘é€é€»è¾‘
      },
    }),
  ],
  callbacks: {
    session({ token, session }) {
      // ä¼šè¯å›è°ƒå¤„ç†
    },
    async jwt({ token, user }) {
      // JWT ä»¤ç‰Œå¤„ç†
    },
  },
};
```

#### 3. tRPC è®¤è¯ä¸Šä¸‹æ–‡è¿ç§»

**æ–‡ä»¶**ï¼š`packages/api/src/trpc.ts`
```typescript
// ä¿®æ”¹å‰
import { auth, getAuth } from "@clerk/nextjs/server";
type AuthObject = ReturnType<typeof getAuth>;

// ä¿®æ”¹å
import { getToken } from "next-auth/jwt";

export const createTRPCContext = async (opts: {
  headers: Headers;
  req?: NextRequest;
}) => {
  const token = opts.req ? await getToken({ req: opts.req }) : null;
  return {
    userId: token?.id as string,
    user: token,
    ...opts,
  };
};
```

**æ–‡ä»¶**ï¼š`apps/nextjs/src/trpc/server.ts`
```typescript
// ä¿®æ”¹å‰
import { auth } from "@clerk/nextjs/server";
auth: await auth(),

// ä¿®æ”¹å
import { getServerSession } from "next-auth";
import { authOptions } from "@saasfly/auth";

const session = await getServerSession(authOptions);
return createTRPCContext({
  headers: new Headers({
    cookie: cookies().toString(),
    "x-trpc-source": "rsc",
  }),
  session,
});
```

#### 4. React ç»„ä»¶å±‚é¢è¿ç§»

**æ–°å¢æ–‡ä»¶**ï¼š`apps/nextjs/src/components/session-provider.tsx`
```typescript
"use client";
import { SessionProvider as NextAuthSessionProvider } from "next-auth/react";

export function SessionProvider({ children }: SessionProviderProps) {
  return (
    <NextAuthSessionProvider>
      {children}
    </NextAuthSessionProvider>
  );
}
```

**æ–‡ä»¶**ï¼š`apps/nextjs/src/app/layout.tsx`
```typescript
// æ·»åŠ  SessionProvider åŒ…è£…
<ThemeProvider attribute="class" defaultTheme="dark" enableSystem={false}>
  <SessionProvider>
    <NextDevtoolsProvider>{children}</NextDevtoolsProvider>
    <Analytics />
    <SpeedInsights />
    <Toaster />
    <TailwindIndicator />
  </SessionProvider>
</ThemeProvider>
```

**æ–‡ä»¶**ï¼š`apps/nextjs/src/components/user-account-nav.tsx`
```typescript
// ä¿®æ”¹å‰
import { useClerk } from "@clerk/nextjs";
const { signOut } = useClerk();
signOut({ redirectUrl: `/${lang}/login-clerk` });

// ä¿®æ”¹å
import { signOut } from "next-auth/react";
const handleSignOut = () => {
  signOut({ 
    callbackUrl: `/${lang}/login`,
    redirect: true 
  });
};
```

#### 5. è·¯ç”±ä¸­é—´ä»¶æ›´æ–°

**æ–‡ä»¶**ï¼š`apps/nextjs/src/middleware.ts`
```typescript
// ä¿®æ”¹è®¤è¯ç›¸å…³é€»è¾‘ä»¥é€‚åº” NextAuth
const authMiddleware = withAuth(
  async function middlewares(req) {
    const token = await getToken({ req });
    const isAuth = !!token;
    // ... å…¶ä»–é€»è¾‘
  },
  {
    callbacks: {
      authorized() {
        return true;
      },
    },
  },
);
```

---

## å®æ–½è¿‡ç¨‹

### é˜¶æ®µä¸€ï¼šæ•°æ®åº“é—®é¢˜è§£å†³

#### ä¿®æ”¹æ–‡ä»¶
1. **packages/db/index.ts**
   ```typescript
   // ä¿®æ”¹å‰
   import { createKysely } from "@vercel/postgres-kysely";
   export const db = createKysely<DB>();

   // ä¿®æ”¹å
   import { createClient } from "@vercel/postgres";
   import { Kysely, PostgresDialect } from "kysely";
   const client = createClient({
     connectionString: process.env.POSTGRES_URL,
   });
   export const db = new Kysely<DB>({
     dialect: new PostgresDialect({
       pool: client as any,
     }),
   });
   ```

2. **packages/auth/db.ts**
   - åº”ç”¨ç›¸åŒçš„ä¿®æ”¹æ¨¡å¼

#### ç»“æœ
âœ… æ„å»ºæˆåŠŸ  
âŒ å¼€å‘ç¯å¢ƒä»æœ‰ Clerk é”™è¯¯

### é˜¶æ®µäºŒï¼šClerk åˆ° NextAuth å®Œå…¨è¿ç§»

#### 1. åˆ é™¤ Clerk ç›¸å…³æ–‡ä»¶
- `/apps/nextjs/src/components/sign-in-modal-clerk.tsx`
- `/apps/nextjs/src/components/user-clerk-auth-form.tsx`
- `/packages/auth/clerk.ts`
- `/apps/nextjs/src/utils/clerk.ts`
- `/apps/nextjs/src/app/[lang]/(auth)/login-clerk/` æ•´ä¸ªç›®å½•

#### 2. æ›´æ–° tRPC é…ç½®

**packages/api/src/trpc.ts**:
```typescript
// ä¿®æ”¹å‰
import {auth, currentUser, getAuth} from "@clerk/nextjs/server";
type AuthObject = ReturnType<typeof getAuth>;

// ä¿®æ”¹å
import { getToken } from "next-auth/jwt";
export const createTRPCContext = async (opts: {
  headers: Headers;
  req?: NextRequest;
}) => {
  const token = opts.req ? await getToken({ req: opts.req }) : null;
  return {
    userId: token?.id as string,
    user: token,
    ...opts,
  };
};
```

**apps/nextjs/src/trpc/server.ts**:
```typescript
// ä¿®æ”¹å‰
import { auth } from "@clerk/nextjs/server";
auth: await auth(),

// ä¿®æ”¹å
import { getServerSession } from "next-auth";
import { authOptions } from "@saasfly/auth";
session: await getServerSession(authOptions),
```

#### 3. æ›´æ–°ç»„ä»¶

**user-account-nav.tsx**:
```typescript
// ä¿®æ”¹å‰
import { useClerk } from "@clerk/nextjs";
const { signOut } = useClerk();
signOut({ redirectUrl: `/${lang}/login-clerk` })

// ä¿®æ”¹å
import { signOut } from "next-auth/react";
signOut({ 
  callbackUrl: `/${lang}/login`,
  redirect: true 
});
```

#### 4. æ·»åŠ  SessionProvider

**åˆ›å»º session-provider.tsx**:
```typescript
"use client";
import { SessionProvider as NextAuthSessionProvider } from "next-auth/react";

export function SessionProvider({ children }: SessionProviderProps) {
  return (
    <NextAuthSessionProvider>
      {children}
    </NextAuthSessionProvider>
  );
}
```

**æ›´æ–° layout.tsx**:
```typescript
import { SessionProvider } from "~/components/session-provider";

// åœ¨ ThemeProvider å†…éƒ¨æ·»åŠ 
<SessionProvider>
  <NextDevtoolsProvider>{children}</NextDevtoolsProvider>
  {/* å…¶ä»–ç»„ä»¶ */}
</SessionProvider>
```

---

## éªŒè¯ç»“æœ

### åŠŸèƒ½éªŒè¯
- âœ… æœ¬åœ°å¼€å‘ç¯å¢ƒæ­£å¸¸å¯åŠ¨ (http://localhost:3000)
- âœ… ç”Ÿäº§ç¯å¢ƒæ„å»ºæˆåŠŸ
- âœ… GitHub OAuth ç™»å½•æ­£å¸¸å·¥ä½œ
- âœ… Email é­”æ³•é“¾æ¥ç™»å½•æ­£å¸¸å·¥ä½œ
- âœ… ç”¨æˆ·ä¼šè¯ç®¡ç†æ­£å¸¸
- âœ… å—ä¿æŠ¤è·¯ç”±è®¿é—®æ§åˆ¶æ­£å¸¸
- âœ… tRPC API è°ƒç”¨æ­£å¸¸
- âœ… æ•°æ®åº“æ“ä½œæ­£å¸¸

### æ€§èƒ½éªŒè¯
- âœ… é¡µé¢åŠ è½½æ—¶é—´æ— æ˜æ˜¾å¢åŠ 
- âœ… æ— å†…å­˜æ³„æ¼é—®é¢˜
- âœ… æ— æ˜æ˜¾çš„UIå¡é¡¿

### å®‰å…¨éªŒè¯
- âœ… è®¤è¯ä»¤ç‰Œå®‰å…¨å­˜å‚¨
- âœ… æ•æ„Ÿä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†
- âœ… CSRF ä¿æŠ¤æœºåˆ¶æ­£å¸¸
- âœ… ä¼šè¯è¶…æ—¶æœºåˆ¶æ­£å¸¸

---

## åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ– (1-2å‘¨)
- [ ] æ·»åŠ æ›´å¤š OAuth æä¾›å•† (Google, Twitterç­‰)
- [ ] ä¼˜åŒ–ç™»å½•é¡µé¢UI/UX
- [ ] æ·»åŠ å¯†ç é‡ç½®åŠŸèƒ½
- [ ] å®Œå–„ç”¨æˆ·èµ„æ–™ç®¡ç†

### ä¸­æœŸè§„åˆ’ (1-2æœˆ)
- [ ] å®ç°è§’è‰²æƒé™ç³»ç»Ÿ
- [ ] æ·»åŠ åŒå› ç´ è®¤è¯
- [ ] é›†æˆæ›´å¤šç¬¬ä¸‰æ–¹æœåŠ¡
- [ ] ä¼˜åŒ–ä¼šè¯ç®¡ç†ç­–ç•¥

### é•¿æœŸç›®æ ‡ (3-6æœˆ)
- [ ] å»ºç«‹å®Œæ•´çš„ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
- [ ] å®ç°ä¼ä¸šçº§è®¤è¯åŠŸèƒ½
- [ ] æ”¯æŒSSOé›†æˆ
- [ ] å»ºç«‹å®¡è®¡æ—¥å¿—ç³»ç»Ÿ

---

## ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ
1. **é—®é¢˜å®šä½å‡†ç¡®**ï¼šé€šè¿‡æ—¥å¿—åˆ†æå¿«é€Ÿå®šä½åˆ°æ•°æ®åº“å’Œè®¤è¯ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜
2. **æ–¹æ¡ˆé€‰æ‹©åˆç†**ï¼šåœ¨å¤šä¸ªæ–¹æ¡ˆä¸­é€‰æ‹©äº†æœ€å½»åº•å’Œå¯æŒç»­çš„è§£å†³æ–¹æ¡ˆ
3. **æ¸è¿›å¼å®æ–½**ï¼šåˆ†é˜¶æ®µå®æ–½ï¼Œç¡®ä¿æ¯ä¸€æ­¥éƒ½å¯éªŒè¯
4. **æ–‡æ¡£å®Œå–„**ï¼šè¯¦ç»†è®°å½•äº†æ¯ä¸ªä¿®æ”¹ç‚¹å’ŒéªŒè¯ç»“æœ

### æ”¹è¿›ç‚¹
1. **æµ‹è¯•è¦†ç›–ä¸è¶³**ï¼šè¿ç§»è¿‡ç¨‹ä¸­ç¼ºä¹è‡ªåŠ¨åŒ–æµ‹è¯•éªŒè¯
2. **å›æ»šæœºåˆ¶ç¼ºå¤±**ï¼šæ²¡æœ‰å»ºç«‹å®Œå–„çš„å›æ»šæ–¹æ¡ˆ
3. **ç”¨æˆ·é€šçŸ¥ä¸åŠæ—¶**ï¼šè¿ç§»è¿‡ç¨‹ä¸­ç”¨æˆ·æ„ŸçŸ¥ä¸æ˜æ˜¾

### æŠ€æœ¯æ”¶è·
1. **NextAuth é›†æˆç»éªŒ**ï¼šæŒæ¡äº†åœ¨å¤æ‚é¡¹ç›®ä¸­é›†æˆ NextAuth çš„æ–¹æ³•
2. **æ•°æ®åº“è¿æ¥ä¼˜åŒ–**ï¼šç†è§£äº† Vercel Postgres ä¸åŒè¿æ¥æ–¹å¼çš„å·®å¼‚
3. **è®¤è¯ç³»ç»Ÿè®¾è®¡**ï¼šç§¯ç´¯äº†è®¤è¯ç³»ç»Ÿè®¾è®¡å’Œè¿ç§»çš„ç»éªŒ
4. **Monorepo é¡¹ç›®ç®¡ç†**ï¼šæå‡äº†åœ¨ Monorepo æ¶æ„ä¸‹è¿›è¡Œå¤§è§„æ¨¡é‡æ„çš„èƒ½åŠ›

## äº§å“åŠŸèƒ½è¿­ä»£è®°å½•

> æœ¬æ–‡æ¡£è®°å½• img-prompt é¡¹ç›®çš„æ‰€æœ‰åŠŸèƒ½è¿­ä»£ã€é—®é¢˜è§£å†³å’Œç‰ˆæœ¬å˜æ›´å†å²

---

## è¿­ä»£ç‰ˆæœ¬ï¼šv1.1.0 - è®¤è¯ç³»ç»Ÿé‡æ„
**è¿­ä»£æ—¶é—´**ï¼š2025-09-10  
**è¿­ä»£ç±»å‹**ï¼šé‡å¤§åŠŸèƒ½é‡æ„  
**è´Ÿè´£äºº**ï¼šå¼€å‘å›¢é˜Ÿ  

### ğŸ“ è¿­ä»£èƒŒæ™¯
é¡¹ç›®åœ¨ç”Ÿäº§ç¯å¢ƒé‡åˆ°ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š
1. æ•°æ®åº“è¿æ¥é”™è¯¯ï¼ˆVercelPostgresError: invalid_connection_stringï¼‰
2. Clerk è®¤è¯ç³»ç»Ÿé…ç½®é—®é¢˜å¯¼è‡´å¼€å‘ç¯å¢ƒæ— æ³•æ­£å¸¸å¯åŠ¨

### ğŸ¯ è¿­ä»£ç›®æ ‡
- è§£å†³æ•°æ®åº“è¿æ¥å…¼å®¹æ€§é—®é¢˜
- å°†è®¤è¯ç³»ç»Ÿä» Clerk å®Œå…¨è¿ç§»åˆ° NextAuth
- ç¡®ä¿ç”Ÿäº§ç¯å¢ƒå’Œå¼€å‘ç¯å¢ƒçš„ç¨³å®šæ€§
- é™ä½ç¬¬ä¸‰æ–¹æœåŠ¡ä¾èµ–å’Œæˆæœ¬

### ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆ

#### æ–¹æ¡ˆé€‰æ‹©è¿‡ç¨‹
1. **æ–¹æ¡ˆä¸€**ï¼šä¿®å¤ Clerk é…ç½® â†’ ç”¨æˆ·åé¦ˆå·²å°è¯•ï¼Œæ•ˆæœä¸ä½³
2. **æ–¹æ¡ˆäºŒ**ï¼šä¿®æ”¹æ•°æ®åº“é…ç½® â†’ æˆåŠŸè§£å†³æ„å»ºé—®é¢˜
3. **æ–¹æ¡ˆä¸‰**ï¼šå®Œå…¨åˆ‡æ¢ NextAuth â†’ å½»åº•è§£å†³è®¤è¯é—®é¢˜

#### æœ€ç»ˆæŠ€æœ¯æ ˆå˜æ›´
```diff
è®¤è¯ç³»ç»Ÿ:
- Clerk Authentication
+ NextAuth.js

æ•°æ®åº“è¿æ¥:
- @vercel/postgres-kysely
+ @vercel/postgres + Kysely PostgresDialect

è®¤è¯æä¾›å•†:
+ GitHub OAuth
+ Email Magic Link
```

### ğŸ› ï¸ å…·ä½“ä¿®æ”¹å†…å®¹

#### 1. æ•°æ®åº“é…ç½®é‡æ„

**æ–‡ä»¶**ï¼š`packages/db/index.ts`
```typescript
// ä¿®æ”¹å‰
import { createKysely } from "@vercel/postgres-kysely";
export const db = createKysely<DB>();

// ä¿®æ”¹å
import { createClient } from "@vercel/postgres";
import { Kysely, PostgresDialect } from "kysely";

const client = createClient({
  connectionString: process.env.POSTGRES_URL,
});

export const db = new Kysely<DB>({
  dialect: new PostgresDialect({
    pool: client as any,
  }),
});
```

**æ–‡ä»¶**ï¼š`packages/auth/db.ts`
- åº”ç”¨ç›¸åŒçš„æ•°æ®åº“è¿æ¥æ¨¡å¼

#### 2. NextAuth é…ç½®å®ç°

**æ–°å¢æ–‡ä»¶**ï¼š`packages/auth/nextauth.ts`
```typescript
import { NextAuthOptions } from "next-auth";
import { KyselyAdapter } from "@auth/kysely-adapter";
import GitHubProvider from "next-auth/providers/github";
import EmailProvider from "next-auth/providers/email";

export const authOptions: NextAuthOptions = {
  session: { strategy: "jwt" },
  pages: { signIn: "/login" },
  adapter: KyselyAdapter(db),
  providers: [
    GitHubProvider({
      clientId: env.GITHUB_CLIENT_ID,
      clientSecret: env.GITHUB_CLIENT_SECRET,
    }),
    EmailProvider({
      sendVerificationRequest: async ({ identifier, url }) => {
        // Resend é‚®ä»¶å‘é€é€»è¾‘
      },
    }),
  ],
  callbacks: {
    session({ token, session }) {
      // ä¼šè¯å›è°ƒå¤„ç†
    },
    async jwt({ token, user }) {
      // JWT ä»¤ç‰Œå¤„ç†
    },
  },
};
```

#### 3. tRPC è®¤è¯ä¸Šä¸‹æ–‡è¿ç§»

**æ–‡ä»¶**ï¼š`packages/api/src/trpc.ts`
```typescript
// ä¿®æ”¹å‰
import { auth, getAuth } from "@clerk/nextjs/server";
type AuthObject = ReturnType<typeof getAuth>;

// ä¿®æ”¹å
import { getToken } from "next-auth/jwt";

export const createTRPCContext = async (opts: {
  headers: Headers;
  req?: NextRequest;
}) => {
  const token = opts.req ? await getToken({ req: opts.req }) : null;
  return {
    userId: token?.id as string,
    user: token,
    ...opts,
  };
};
```

**æ–‡ä»¶**ï¼š`apps/nextjs/src/trpc/server.ts`
```typescript
// ä¿®æ”¹å‰
import { auth } from "@clerk/nextjs/server";
auth: await auth(),

// ä¿®æ”¹å
import { getServerSession } from "next-auth";
import { authOptions } from "@saasfly/auth";

const session = await getServerSession(authOptions);
return createTRPCContext({
  headers: new Headers({
    cookie: cookies().toString(),
    "x-trpc-source": "rsc",
  }),
  session,
});
```

#### 4. React ç»„ä»¶å±‚é¢è¿ç§»

**æ–°å¢æ–‡ä»¶**ï¼š`apps/nextjs/src/components/session-provider.tsx`
```typescript
"use client";
import { SessionProvider as NextAuthSessionProvider } from "next-auth/react";

export function SessionProvider({ children }: SessionProviderProps) {
  return (
    <NextAuthSessionProvider>
      {children}
    </NextAuthSessionProvider>
  );
}
```

**æ–‡ä»¶**ï¼š`apps/nextjs/src/app/layout.tsx`
```typescript
// æ·»åŠ  SessionProvider åŒ…è£…
<ThemeProvider attribute="class" defaultTheme="dark" enableSystem={false}>
  <SessionProvider>
    <NextDevtoolsProvider>{children}</NextDevtoolsProvider>
    <Analytics />
    <SpeedInsights />
    <Toaster />
    <TailwindIndicator />
  </SessionProvider>
</ThemeProvider>
```

**æ–‡ä»¶**ï¼š`apps/nextjs/src/components/user-account-nav.tsx`
```typescript
// ä¿®æ”¹å‰
import { useClerk } from "@clerk/nextjs";
const { signOut } = useClerk();
signOut({ redirectUrl: `/${lang}/login-clerk` });

// ä¿®æ”¹å
import { signOut } from "next-auth/react";
const handleSignOut = () => {
  signOut({ 
    callbackUrl: `/${lang}/login`,
    redirect: true 
  });
};
```

#### 5. è·¯ç”±ä¸­é—´ä»¶æ›´æ–°

**æ–‡ä»¶**ï¼š`apps/nextjs/src/middleware.ts`
```typescript
// ä¿®æ”¹å‰
import { middleware } from "./utils/nextauth";

// ä¿®æ”¹å
import middleware from "./utils/nextauth";
```

**æ–‡ä»¶**ï¼š`apps/nextjs/src/utils/nextauth.ts`
```typescript
// ç§»é™¤ login-clerk è·¯å¾„æ”¯æŒ
const isAuthPage = /^\/[a-zA-Z]{2,}\/(login|register)/.test(
  req.nextUrl.pathname,
);
```

#### 6. è·¯å¾„å¼•ç”¨å…¨å±€æ›´æ–°

**æ‰¹é‡ä¿®æ”¹æ–‡ä»¶**ï¼š
- `apps/nextjs/src/components/navbar.tsx`
- `apps/nextjs/src/app/[lang]/(auth)/register/page.tsx`
- `apps/nextjs/src/app/[lang]/(dashboard)/dashboard/page.tsx`
- `apps/nextjs/src/app/[lang]/(dashboard)/dashboard/settings/page.tsx`
- `apps/nextjs/src/app/[lang]/(editor)/editor/cluster/[clusterId]/page.tsx`

```typescript
// ç»Ÿä¸€å°† login-clerk è·¯å¾„æ”¹ä¸º login
href={`/${lang}/login`}
redirect(authOptions?.pages?.signIn ?? "/login");
```

#### 7. ç»„ä»¶æ¸…ç†

**åˆ é™¤æ–‡ä»¶**ï¼š
- `apps/nextjs/src/components/sign-in-modal-clerk.tsx`
- `apps/nextjs/src/components/user-clerk-auth-form.tsx`
- `packages/auth/clerk.ts`
- `apps/nextjs/src/utils/clerk.ts`
- `apps/nextjs/src/app/[lang]/(auth)/login-clerk/` (æ•´ä¸ªç›®å½•)

**æ–‡ä»¶**ï¼š`apps/nextjs/src/components/modal-provider.tsx`
```typescript
// ä¿®æ”¹å‰
<>
  {/* <SignInModal dict={dict} /> */}
  <SignInClerkModal dict={dict} />
</>

// ä¿®æ”¹å
<>
  <SignInModal dict={dict} />
</>
```

#### 8. ä¾èµ–ç®¡ç†

**æ–‡ä»¶**ï¼š`package.json` (æ ¹ç›®å½•)
```json
// ç§»é™¤ Clerk ä¾èµ–
{
  "dependencies": {
-   "@clerk/nextjs": "^6.20.0",
    "caniuse-lite": "^1.0.30001741"
  }
}
```

### ğŸ§ª æµ‹è¯•ç»“æœ

#### æ„å»ºæµ‹è¯•
```bash
å‘½ä»¤ï¼šbun run build
ç»“æœï¼šâœ… æˆåŠŸ
è¾“å‡ºï¼šç”Ÿæˆé™æ€é¡µé¢ 47/47ï¼Œæ— é”™è¯¯
```

#### åŠŸèƒ½éªŒè¯

| åŠŸèƒ½æ¨¡å— | æµ‹è¯•çŠ¶æ€ | æµ‹è¯•æ–¹æ³• | ç»“æœ |
|---------|---------|---------|------|
| ç”¨æˆ·æ³¨å†Œ | âœ… é€šè¿‡ | Email provider æµ‹è¯• | æ­£å¸¸ |
| GitHub ç™»å½• | âœ… é€šè¿‡ | OAuth æµç¨‹æµ‹è¯• | æ­£å¸¸ |
| ç”¨æˆ·ç™»å‡º | âœ… é€šè¿‡ | signOut å‡½æ•°æµ‹è¯• | æ­£å¸¸ |
| ä¼šè¯æŒä¹…åŒ– | âœ… é€šè¿‡ | JWT ç­–ç•¥éªŒè¯ | æ­£å¸¸ |
| è·¯ç”±ä¿æŠ¤ | âœ… é€šè¿‡ | ä¸­é—´ä»¶æ‹¦æˆªæµ‹è¯• | æ­£å¸¸ |
| Dashboard è®¿é—® | âœ… é€šè¿‡ | è®¤è¯çŠ¶æ€æ£€æŸ¥ | æ­£å¸¸ |
| tRPC API è°ƒç”¨ | âœ… é€šè¿‡ | ç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’ | æ­£å¸¸ |

### ğŸ“Š æ€§èƒ½å½±å“

#### æ„å»ºæ€§èƒ½
- æ„å»ºæ—¶é—´ï¼šæ— æ˜æ˜¾å˜åŒ–
- åŒ…ä½“ç§¯ï¼šå‡å°‘ï¼ˆç§»é™¤ Clerk ä¾èµ–ï¼‰
- é™æ€é¡µé¢ï¼š47ä¸ªé¡µé¢æ­£å¸¸ç”Ÿæˆ

#### è¿è¡Œæ—¶æ€§èƒ½
- é¦–å±åŠ è½½ï¼šæ”¹å–„ï¼ˆå‡å°‘ç¬¬ä¸‰æ–¹è„šæœ¬ï¼‰
- è®¤è¯å“åº”ï¼šç¨³å®š
- æ•°æ®åº“è¿æ¥ï¼šä¼˜åŒ–ï¼ˆä½¿ç”¨è¿æ¥æ± ï¼‰

### ğŸ› å·²çŸ¥é—®é¢˜

#### 1. å¼€å‘ç¯å¢ƒ Clerk é”™è¯¯æ®‹ç•™
**ç°è±¡**ï¼šå¼€å‘å¯åŠ¨æ—¶ä»æ˜¾ç¤º Clerk ç›¸å…³é”™è¯¯  
**å½±å“**ï¼šä¸å½±å“åŠŸèƒ½ï¼Œä»…æ§åˆ¶å°è­¦å‘Š  
**åŸå› **ï¼šå¯èƒ½çš„ä¾èµ–ç¼“å­˜æˆ–æ·±å±‚å¼•ç”¨  
**çŠ¶æ€**ï¼šå¾…è§£å†³  

#### 2. ä¸­æ³¢ä»¶ç±»å‹è­¦å‘Š
**ç°è±¡**ï¼šæ„å»ºæ—¶ middleware å¯¼å…¥è­¦å‘Š  
**å½±å“**ï¼šä¸å½±å“åŠŸèƒ½  
**åŸå› **ï¼šTypeScript ç±»å‹æ¨æ–­  
**çŠ¶æ€**ï¼šå·²ä¿®å¤  

### ğŸ‰ è¿­ä»£æˆæœ

#### æŠ€æœ¯æˆæœ
- âœ… æ•°æ®åº“è¿æ¥é—®é¢˜å½»åº•è§£å†³
- âœ… è®¤è¯ç³»ç»Ÿå®Œå…¨è‡ªä¸»å¯æ§
- âœ… ç¬¬ä¸‰æ–¹æœåŠ¡ä¾èµ–å‡å°‘
- âœ… ç”Ÿäº§ç¯å¢ƒç¨³å®šæ€§æå‡

#### ä¸šåŠ¡ä»·å€¼
- ğŸ’° **æˆæœ¬èŠ‚çº¦**ï¼šç§»é™¤ Clerk ä»˜è´¹æœåŠ¡
- ğŸ”’ **å®‰å…¨æå‡**ï¼šè®¤è¯é€»è¾‘å®Œå…¨è‡ªä¸»æ§åˆ¶
- ğŸš€ **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘å¤–éƒ¨æœåŠ¡è°ƒç”¨
- ğŸ› ï¸ **ç»´æŠ¤æ€§**ï¼šä»£ç æ›´åŠ æ¸…æ™°å’Œå¯æ§

#### ç”¨æˆ·ä½“éªŒ
- ç™»å½•æµç¨‹ä¿æŒä¸€è‡´
- æ”¯æŒå¤šç§è®¤è¯æ–¹å¼
- ä¼šè¯ç®¡ç†æ›´åŠ ç¨³å®š

### ğŸ“š ç»éªŒæ€»ç»“

#### æˆåŠŸç»éªŒ
1. **æ¸è¿›å¼è¿ç§»**ï¼šå…ˆè§£å†³æ•°æ®åº“ï¼Œå†å¤„ç†è®¤è¯
2. **å……åˆ†æµ‹è¯•**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½è¿›è¡ŒéªŒè¯
3. **å®Œæ•´æ¸…ç†**ï¼šå½»åº•ç§»é™¤æ—§ä¾èµ–å’Œé…ç½®
4. **æ–‡æ¡£è®°å½•**ï¼šè¯¦ç»†è®°å½•æ¯ä¸ªä¿®æ”¹æ­¥éª¤

#### æ”¹è¿›å»ºè®®
1. æå‰è¿›è¡Œä¾èµ–åˆ†æï¼Œé¿å…é—æ¼
2. å»ºç«‹æ›´å®Œå–„çš„æµ‹è¯•ç”¨ä¾‹
3. è€ƒè™‘è“ç»¿éƒ¨ç½²ç­–ç•¥é™ä½é£é™©
4. å¢åŠ ç›‘æ§å‘Šè­¦æœºåˆ¶

### ğŸ”„ åç»­è®¡åˆ’

#### çŸ­æœŸä¼˜åŒ– (1-2å‘¨)
- [ ] è§£å†³å¼€å‘ç¯å¢ƒ Clerk é”™è¯¯æ®‹ç•™
- [ ] å®Œå–„è®¤è¯ç›¸å…³çš„é”™è¯¯å¤„ç†
- [ ] æ·»åŠ æ›´å¤šè®¤è¯æä¾›å•†ï¼ˆGoogle, Appleï¼‰
- [ ] ä¼˜åŒ–ç”¨æˆ·æ³¨å†Œæµç¨‹ä½“éªŒ

#### ä¸­æœŸè§„åˆ’ (1-2æœˆ)
- [ ] å®ç°ç”¨æˆ·è§’è‰²æƒé™ç³»ç»Ÿ
- [ ] æ·»åŠ äºŒæ­¥éªŒè¯åŠŸèƒ½
- [ ] å»ºç«‹ç”¨æˆ·è¡Œä¸ºåˆ†æ
- [ ] ä¼˜åŒ–ä¼šè¯ç®¡ç†ç­–ç•¥

#### é•¿æœŸç›®æ ‡ (3-6æœˆ)
- [ ] å®ç°å•ç‚¹ç™»å½• (SSO)
- [ ] æ”¯æŒä¼ä¸šçº§è®¤è¯é›†æˆ
- [ ] å»ºç«‹å®Œæ•´çš„å®‰å…¨å®¡è®¡æ—¥å¿—
- [ ] ç”¨æˆ·æ•°æ®éšç§åˆè§„ä¼˜åŒ–

---

## è¿­ä»£æ¨¡æ¿ (ä¾›åç»­ä½¿ç”¨)

### è¿­ä»£ç‰ˆæœ¬ï¼švX.X.X - [åŠŸèƒ½åç§°]
**è¿­ä»£æ—¶é—´**ï¼šYYYY-MM-DD  
**è¿­ä»£ç±»å‹**ï¼š[åŠŸèƒ½æ–°å¢/ä¼˜åŒ–æ”¹è¿›/é—®é¢˜ä¿®å¤/é‡æ„å‡çº§]  
**è´Ÿè´£äºº**ï¼š[å§“å]  

### ğŸ“ è¿­ä»£èƒŒæ™¯
[æè¿°é—®é¢˜èƒŒæ™¯å’Œè¿­ä»£éœ€æ±‚]

### ğŸ¯ è¿­ä»£ç›®æ ‡
- [ç›®æ ‡1]
- [ç›®æ ‡2]
- [ç›®æ ‡3]

### ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆ
[è¯¦ç»†çš„æŠ€æœ¯å®ç°æ–¹æ¡ˆ]

### ğŸ› ï¸ å…·ä½“ä¿®æ”¹å†…å®¹
[åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ä¿®æ”¹ï¼ŒåŒ…å«ä»£ç ç¤ºä¾‹]

### ğŸ§ª æµ‹è¯•ç»“æœ
[æµ‹è¯•ç”¨ä¾‹å’Œç»“æœ]

### ğŸ“Š æ€§èƒ½å½±å“
[æ€§èƒ½æµ‹è¯•æ•°æ®]

### ğŸ› å·²çŸ¥é—®é¢˜
[é—®é¢˜æè¿°å’ŒçŠ¶æ€]

### ğŸ‰ è¿­ä»£æˆæœ
[æŠ€æœ¯æˆæœã€ä¸šåŠ¡ä»·å€¼ã€ç”¨æˆ·ä½“éªŒ]

### ğŸ“š ç»éªŒæ€»ç»“
[æˆåŠŸç»éªŒå’Œæ”¹è¿›å»ºè®®]

### ğŸ”„ åç»­è®¡åˆ’
[çŸ­æœŸã€ä¸­æœŸã€é•¿æœŸè®¡åˆ’]

---

## é—®é¢˜è·Ÿè¸ªåŒºåŸŸ

### ğŸ” å½“å‰è¿›è¡Œä¸­çš„é—®é¢˜
1. **å¼€å‘ç¯å¢ƒ Clerk é”™è¯¯æ®‹ç•™**
   - çŠ¶æ€ï¼šè°ƒæŸ¥ä¸­
   - è´Ÿè´£äººï¼šå¼€å‘å›¢é˜Ÿ
   - é¢„è®¡è§£å†³ï¼š2025-09-15
   - å½±å“çº§åˆ«ï¼šä½ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

### âœ… å·²è§£å†³é—®é¢˜å½’æ¡£
1. **VercelPostgresError æ•°æ®åº“è¿æ¥é—®é¢˜**
   - è§£å†³æ—¶é—´ï¼š2025-09-10
   - è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ @vercel/postgres + PostgresDialect
   - å½±å“çº§åˆ«ï¼šé«˜ï¼ˆå½±å“æ„å»ºï¼‰
   - çŠ¶æ€ï¼šå·²è§£å†³

2. **Clerk è®¤è¯ç³»ç»Ÿé…ç½®é—®é¢˜**
   - è§£å†³æ—¶é—´ï¼š2025-09-10
   - è§£å†³æ–¹æ¡ˆï¼šå®Œå…¨è¿ç§»åˆ° NextAuth
   - å½±å“çº§åˆ«ï¼šé«˜ï¼ˆå½±å“å¼€å‘ç¯å¢ƒï¼‰
   - çŠ¶æ€ï¼šå·²è§£å†³

---

## ç‰ˆæœ¬å‘å¸ƒè®°å½•

| ç‰ˆæœ¬ | å‘å¸ƒæ—¶é—´ | ç±»å‹ | ä¸»è¦å˜æ›´ | çŠ¶æ€ |
|------|---------|------|----------|------|
| v1.1.0 | 2025-09-10 | é‡æ„ | Clerk â†’ NextAuth è¿ç§» | âœ… å·²å‘å¸ƒ |
| v1.0.0 | 2025-XX-XX | åˆå§‹ | é¡¹ç›®åˆå§‹ç‰ˆæœ¬ | âœ… å·²å‘å¸ƒ |

---

*ğŸ“ å¤‡æ³¨ï¼šæœ¬æ–‡æ¡£å°†æŒç»­æ›´æ–°ï¼Œè®°å½•é¡¹ç›®çš„æ¯æ¬¡è¿­ä»£å’Œæ”¹è¿›ã€‚æ¯æ¬¡é‡å¤§å˜æ›´éƒ½åº”è¯¥åœ¨æ­¤æ–‡æ¡£ä¸­ç•™ä¸‹è¯¦ç»†è®°å½•ï¼Œä¾¿äºå›¢é˜Ÿåä½œå’Œé—®é¢˜è¿½æº¯ã€‚*