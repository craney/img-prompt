# img-prompt 项目：Image to Prompt 功能页面技术方案

## 项目概述

**项目名称**: Image to Prompt 功能页面开发  
**技术方案版本**: v3.0  
**设计日期**: 2025-09-11  
**对应产品文档**: 产品功能迭代v3.md  
**项目架构**: 基于现有 Next.js 14 + Monorepo 架构  

---

## 需求背景

### 业务需求
复刻 https://imageprompt.org/image-to-prompt 页面功能，实现完整的"图片转提示词"工具。用户可以上传图片，选择AI模型，生成对应的图像提示词。

### 技术约束
- 基于现有项目架构，保持代码风格一致
- 复用现有UI组件库和样式系统
- 支持文件上传、图片预处理、AI服务调用
- 确保响应式设计和国际化支持

---

## 技术架构设计

### 路由结构
```
apps/nextjs/src/app/[lang]/(tools)/
├── image-to-prompt/
│   ├── page.tsx                      # 主页面
│   ├── loading.tsx                   # 加载状态
│   ├── error.tsx                     # 错误处理
│   └── components/
│       ├── image-upload-section.tsx  # 上传区域
│       ├── image-preview-section.tsx # 预览区域
│       ├── feature-tabs.tsx          # 功能切换
│       ├── model-selection.tsx       # 模型选择
│       ├── language-selector.tsx     # 语言选择
│       └── prompt-generator.tsx      # 生成器
```

### 核心组件架构

#### 1. 主页面组件 (page.tsx)
#### 2. Coze文件上传API路由

**文件路径**：`apps/nextjs/src/app/api/coze/upload/route.ts`

**功能设计**：
1. 接收前端上传的文件
2. 使用环境变量中的访问令牌
3. 调用Coze API上传文件
4. 返回文件ID和元数据

**安全措施**：
- 访问令牌存储在环境变量中
- 错误处理和日志记录
- 文件类型和大小验证

**代码结构**：
```typescript
export async function POST(request: NextRequest) {
  try {
    // 1. 获取上传的文件
    const formData = await request.formData();
    const file = formData.get("file") as File;

    // 2. 验证文件
    if (!file) return errorResponse(400, "No file provided");

    // 3. 准备Coze API请求
    const cozeFormData = new FormData();
    cozeFormData.append("file", file);
    cozeFormData.append("purpose", "webpage");

    // 4. 获取访问令牌
    const accessToken = env.COZE_ACCESS_TOKEN;
    if (!accessToken) return errorResponse(500, "Coze access token not configured");

    // 5. 调用Coze API
    const response = await fetch("https://api.coze.cn/v1/files/upload", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Accept": "application/json"
      },
      body: cozeFormData,
    });

    // 6. 处理响应
    if (!response.ok) {
      const errorText = await response.text();
      console.error("Coze API error:", errorText);
      return errorResponse(response.status, `Coze API error: ${errorText}`);
    }

    const result = await response.json();
    return successResponse(result);
    
  } catch (error) {
    console.error("Error uploading file to Coze:", error);
    return errorResponse(500, "Failed to upload file to Coze");
  }
}
```

#### 3. 文件上传组件
```typescript
export default async function ImageToPromptPage({
  params: { lang }
}: {
  params: { lang: Locale }
}) {
  const dict = await getDictionary(lang);
  
  return (
    <div className="container mx-auto px-4 py-8 max-w-6xl">
      <ImageToPromptHeader dict={dict.imageToPrompt.header} />
      <FeatureTabs active="image-to-prompt" dict={dict.imageToPrompt.tabs} />
      
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
        <ImageUploadSection dict={dict.imageToPrompt.upload} />
        <ImagePreviewSection dict={dict.imageToPrompt.preview} />
      </div>
      
      <ModelSelection dict={dict.imageToPrompt.models} />
      <PromptGenerator dict={dict.imageToPrompt.generator} />
    </div>
  );
}
```

#### 2. 文件上传组件
```typescript
export function ImageUploadSection({ dict }: Props) {
  const [dragActive, setDragActive] = useState(false);
  const [file, setFile] = useState<File | null>(null);
  const [imageUrl, setImageUrl] = useState("");
  
  const handleDrop = useCallback((e: DragEvent) => {
    e.preventDefault();
    setDragActive(false);
    
    const files = Array.from(e.dataTransfer.files);
    const imageFile = files.find(file => file.type.startsWith('image/'));
    
    if (imageFile && validateFile(imageFile)) {
      setFile(imageFile);
    }
  }, []);
  
  return (
    <div className="space-y-6">
      {/* 拖拽上传区域 */}
      <div 
        className={cn(
          "border-2 border-dashed rounded-xl p-8 text-center transition-all duration-200",
          dragActive ? "border-purple-500 bg-purple-50" : "border-purple-300 hover:border-purple-400"
        )}
        onDrop={handleDrop}
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
      >
        <Icons.Upload className="w-12 h-12 text-purple-500 mx-auto mb-4" />
        <h3 className="text-lg font-medium mb-2">{dict.dragText}</h3>
        <p className="text-sm text-muted-foreground mb-6">{dict.formatText}</p>
        
        <Button 
          variant="outline" 
          onClick={() => fileInputRef.current?.click()}
        >
          {dict.uploadButton}
        </Button>
      </div>
      
      {/* URL 输入 */}
      <div className="flex gap-2">
        <Input
          placeholder={dict.urlPlaceholder}
          value={imageUrl}
          onChange={(e) => setImageUrl(e.target.value)}
          className="flex-1"
        />
        <Button onClick={handleUrlUpload} disabled={!imageUrl}>
          Upload
        </Button>
      </div>
    </div>
  );
}
```

#### 3. 模型选择组件
```typescript
const models = [
  {
    id: 'general',
    title: 'General Image Prompt',
    description: 'Natural language description of the image',
    selected: true
  },
  // ... 其他模型
];

export function ModelSelection({ dict }: Props) {
  const [selectedModel, setSelectedModel] = useState('general');
  
  return (
    <div className="mt-12">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {models.map((model) => (
          <Card 
            key={model.id}
            className={cn(
              "cursor-pointer transition-all duration-200 hover:shadow-md",
              selectedModel === model.id 
                ? "border-purple-500 bg-purple-50 dark:bg-purple-900/10" 
                : "border-gray-200 hover:border-purple-300"
            )}
            onClick={() => setSelectedModel(model.id)}
          >
            <CardContent className="p-4">
              <div className="flex items-start gap-3">
                {selectedModel === model.id && (
                  <Icons.Check className="w-5 h-5 text-purple-600 mt-0.5" />
                )}
                <div>
                  <h3 className="font-medium text-sm mb-2">{model.title}</h3>
                  <p className="text-xs text-muted-foreground">
                    {model.description}
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
}
```

### 状态管理设计

使用 Zustand 进行状态管理：

```typescript
interface ImageToPromptStore {
  // 上传状态
  uploadedFile: File | null;
  uploadedImageUrl: string;
  isUploading: boolean;
  
  // 选择状态
  selectedModel: string;
  promptLanguage: string;
  
  // 生成状态
  generatedPrompt: string;
  isGenerating: boolean;
  
  // Actions
  setUploadedFile: (file: File | null) => void;
  setSelectedModel: (model: string) => void;
  setPromptLanguage: (language: string) => void;
  generatePrompt: () => Promise<void>;
}

export const useImageToPromptStore = create<ImageToPromptStore>((set, get) => ({
  uploadedFile: null,
  uploadedImageUrl: '',
  isUploading: false,
  selectedModel: 'general',
  promptLanguage: 'english',
  generatedPrompt: '',
  isGenerating: false,
  
  setUploadedFile: (file) => set({ uploadedFile: file }),
  setSelectedModel: (model) => set({ selectedModel: model }),
  setPromptLanguage: (language) => set({ promptLanguage: language }),
  
  generatePrompt: async () => {
    set({ isGenerating: true });
    try {
      const { uploadedFile, selectedModel, promptLanguage } = get();
      // API 调用逻辑
      const prompt = await generateImagePrompt({
        file: uploadedFile,
        model: selectedModel,
        language: promptLanguage
      });
      set({ generatedPrompt: prompt });
    } catch (error) {
      console.error('Generate prompt failed:', error);
    } finally {
      set({ isGenerating: false });
    }
  }
}));
```

### API 设计

#### 文件上传 API
```typescript
// apps/nextjs/src/app/api/upload/route.ts
export async function POST(request: Request) {
  const formData = await request.formData();
  const file = formData.get('file') as File;
  
  // 文件验证
  if (!file || !isValidImageFile(file)) {
    return NextResponse.json({ error: 'Invalid file' }, { status: 400 });
  }
  
  // 上传到存储服务
  const uploadUrl = await uploadToStorage(file);
  
  return NextResponse.json({ 
    success: true, 
    url: uploadUrl,
    metadata: {
      size: file.size,
      type: file.type,
      name: file.name
    }
  });
}
```

#### tRPC API 集成
```typescript
// packages/api/src/router/image-prompt.ts
export const imagePromptRouter = createTRPCRouter({
  generatePrompt: protectedProcedure
    .input(z.object({
      imageUrl: z.string().url(),
      model: z.enum(['general', 'flux', 'midjourney', 'stable-diffusion']),
      language: z.enum(['english', 'chinese', 'japanese', 'korean'])
    }))
    .mutation(async ({ input, ctx }) => {
      // 调用 AI 服务
      const prompt = await aiService.generatePrompt({
        imageUrl: input.imageUrl,
        model: input.model,
        language: input.language
      });
      
      // 保存到数据库
      await ctx.db.insertInto('prompts').values({
        userId: ctx.session?.user?.id,
        imageUrl: input.imageUrl,
        model: input.model,
        language: input.language,
        generatedPrompt: prompt,
        createdAt: new Date()
      }).execute();
      
      return { prompt };
    }),
    
  getPromptHistory: protectedProcedure
    .query(async ({ ctx }) => {
      return await ctx.db
        .selectFrom('prompts')
        .where('userId', '=', ctx.session?.user?.id)
        .orderBy('createdAt', 'desc')
        .limit(20)
        .execute();
    })
});
```

### 国际化支持

字典文件扩展：
```json
{
  "imageToPrompt": {
    "meta": {
      "title": "Free Image to Prompt Generator - ImgPrompt.He",
      "description": "Convert images to detailed AI prompts with our free tool."
    },
    "header": {
      "title": "Free Image to Prompt Generator",
      "subtitle": "Convert Image to Prompt to generate your own image"
    },
    "upload": {
      "dragText": "Upload a photo or drag and drop",
      "formatText": "PNG, JPG, or WEBP up to 5MB",
      "uploadButton": "Upload Image",
      "urlPlaceholder": "Input Image URL"
    },
    "models": {
      "general": "General Image Prompt",
      "flux": "Flux",
      "midjourney": "Midjourney",
      "stableDiffusion": "Stable Diffusion"
    }
  }
}
```

### 性能优化策略

#### 1. 图片优化
```typescript
// 图片压缩和优化
export async function optimizeImage(file: File): Promise<File> {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d')!;
    const img = new Image();
    
    img.onload = () => {
      // 计算合适的尺寸
      const { width, height } = calculateOptimalSize(img.width, img.height);
      
      canvas.width = width;
      canvas.height = height;
      
      // 绘制和压缩
      ctx.drawImage(img, 0, 0, width, height);
      canvas.toBlob((blob) => {
        const optimizedFile = new File([blob!], file.name, {
          type: 'image/jpeg',
          lastModified: Date.now()
        });
        resolve(optimizedFile);
      }, 'image/jpeg', 0.8);
    };
    
    img.src = URL.createObjectURL(file);
  });
}
```

#### 2. 代码分割
```typescript
// 动态导入大型组件
const ImageEditor = dynamic(() => import('./image-editor'), {
  loading: () => <Skeleton className="h-64 w-full" />,
  ssr: false
});

const AIModelViewer = dynamic(() => import('./ai-model-viewer'), {
  loading: () => <div>Loading AI models...</div>
});
```

### 错误处理和用户体验

#### 1. 错误边界
```typescript
export function ImageToPromptErrorBoundary({ children }: Props) {
  return (
    <ErrorBoundary
      fallback={({ error, resetError }) => (
        <Card className="p-8 text-center">
          <Icons.AlertCircle className="w-12 h-12 text-red-500 mx-auto mb-4" />
          <h2 className="text-xl font-semibold mb-2">Something went wrong</h2>
          <p className="text-muted-foreground mb-4">{error.message}</p>
          <Button onClick={resetError}>Try again</Button>
        </Card>
      )}
    >
      {children}
    </ErrorBoundary>
  );
}
```

#### 2. 加载状态
```typescript
export function LoadingStates() {
  return (
    <div className="space-y-4">
      <Skeleton className="h-4 w-3/4" />
      <Skeleton className="h-32 w-full" />
      <div className="grid grid-cols-4 gap-4">
        {Array.from({ length: 4 }).map((_, i) => (
          <Skeleton key={i} className="h-24 w-full" />
        ))}
      </div>
    </div>
  );
}
```

### 部署配置

#### 环境变量
```bash
# AI 服务配置
AI_SERVICE_URL=https://api.ai-service.com
AI_SERVICE_API_KEY=your_api_key

# 文件存储
UPLOAD_BUCKET=img-prompt-uploads
UPLOAD_REGION=us-east-1

# 图片处理
MAX_FILE_SIZE=5242880  # 5MB
ALLOWED_FORMATS=png,jpg,jpeg,webp
```

#### Vercel 配置更新
```json
{
  "buildCommand": "turbo run build --filter=@saasfly/nextjs",
  "functions": {
    "apps/nextjs/src/app/api/upload/route.ts": {
      "maxDuration": 30
    }
  },
  "headers": [
    {
      "source": "/api/upload",
      "headers": [
        {
          "key": "Access-Control-Allow-Origin",
          "value": "*"
        }
      ]
    }
  ]
}
```

---

## 实施时间表

### 第1周：基础架构
- [ ] 路由和页面结构搭建
- [ ] 基础组件开发
- [ ] 状态管理实现

### 第2周：核心功能
- [ ] 文件上传功能
- [ ] 图片预览和处理
- [ ] API 集成

### 第3周：优化和测试
- [x] 性能优化
- [x] 错误处理
- [x] 测试覆盖

### 第4周：错误修复和优化 (2025-09-12)
- [x] 字典访问路径错误修复
- [x] Icons组件导入方式修复
- [x] 开发服务器启动优化
- [x] 全面功能测试
- [x] 移除 "Text to Prompt" 功能标签
- [x] 修复 "Input Image URL" 功能

---

## 🔧 v3.0.1 - 功能优化和修复 (2025-09-12)

### 📝 修改背景
根据用户反馈，需要对 Image to Prompt 功能页面进行两处修改：
1. 移除 "Text to Prompt" 功能标签
2. 修复 "Input Image URL" 功能

### 🎯 修改目标
- 简化功能页面，只保留核心的 "Image to Prompt" 功能
- 修复 URL 图片上传功能，使其能够正常工作
- 确保修改后的功能通过测试验证

### 🛠️ 技术实现

#### 1. 移除 "Text to Prompt" 功能标签

**修改文件**: `apps/nextjs/src/app/[lang]/(tools)/image-to-prompt/components/feature-tabs.tsx`

修改了 FeatureTabs 组件，移除了 "Text to Prompt" 标签，只保留 "Image to Prompt" 标签。相应地更新了 TypeScript 接口定义。

#### 2. 修复 "Input Image URL" 功能

**修改文件**: `apps/nextjs/src/app/[lang]/(tools)/image-to-prompt/components/image-upload-section.tsx`

实现了完整的 URL 图片上传功能：
1. 通过 fetch API 获取 URL 指向的图片
2. 将获取的图片数据转换为 File 对象
3. 使用现有的文件验证逻辑验证图片
4. 更新上传状态并触发回调函数

### ✅ 验证结果
- ✅ "Text to Prompt" 标签已成功移除，页面只显示 "Image to Prompt" 标签
- ✅ "Input Image URL" 功能已修复，可以正常从 URL 获取图片并上传
- ✅ 页面功能完整，通过了本地测试验证
- ✅ TypeScript 类型检查通过
- ✅ 开发服务器正常运行 (http://localhost:3003)

---

## 🔧 v3.0.2 - Coze文件上传功能集成 (2025-09-12)

### 📝 修改背景
根据产品需求，需要集成Coze平台的文件上传功能，使用户能够将图片上传到Coze平台并获取文件ID，以便后续在Coze中使用这些文件。

### 🎯 修改目标
- 实现文件上传到Coze平台的功能
- 安全地管理Coze访问令牌，不暴露在前端代码中
- 在上传完成后在控制台打印文件ID
- 提供用户友好的上传界面和反馈

### 🛠️ 技术实现

#### 1. 新增Coze上传API路由

**新增文件**: `apps/nextjs/src/app/api/coze/upload/route.ts`

创建了后端API路由来处理文件上传到Coze，避免前端直接访问Coze API。该路由：
1. 接收前端发送的文件
2. 从环境变量中获取Coze访问令牌
3. 将文件上传到Coze API端点 `https://api.coze.com/v1/files/upload`
4. 将Coze返回的文件信息（包括fileId）返回给前端

#### 2. 环境变量配置

**修改文件**: `apps/nextjs/src/env.mjs`

在环境变量配置中添加了 `COZE_ACCESS_TOKEN`，确保访问令牌安全存储。

#### 3. 前端组件更新

**修改文件**: `apps/nextjs/src/app/[lang]/(tools)/image-to-prompt/components/image-upload-section.tsx`

在现有图片上传组件中集成了Coze上传功能：
1. 新增 `uploadToCoze` 函数处理上传逻辑
2. 使用 useEffect 钩子在文件选择后自动触发Coze上传
3. 添加上传状态管理（加载状态、成功状态、错误状态）
4. 在上传成功后显示Coze文件ID并提供复制功能
5. 按需求在控制台打印文件ID

### ✅ 验证结果
- ✅ Coze文件上传功能正常工作
- ✅ 访问令牌安全存储在环境变量中，未暴露在前端
- ✅ 上传成功后控制台正确打印文件ID
- ✅ UI提供清晰的反馈和操作结果
- ✅ 错误处理机制完善
- ✅ TypeScript 类型检查通过
- ✅ 开发服务器正常运行 (http://localhost:3003)

---

## 🔧 v3.0.3 - Coze上传功能优化 (2025-09-12)

### 📝 修改背景
根据用户反馈，Coze上传功能需要优化，将上传逻辑集成到现有的上传流程中，而不是添加新的按钮。

### 🎯 修改目标
- 将Coze上传功能集成到现有上传流程中
- 文件选择或URL上传后自动触发Coze上传
- 保持用户界面简洁，不增加额外按钮
- 确保上传状态和结果清晰显示

### 🛠️ 技术实现

#### 1. 前端组件优化

**修改文件**: `apps/nextjs/src/app/[lang]/(tools)/image-to-prompt/components/image-upload-section.tsx`

优化了图片上传组件：
1. 移除了额外的"Upload to Coze"按钮
2. 使用 useEffect 钩子监听文件状态变化，在文件选择后自动触发Coze上传
3. 更新了状态管理，添加了 uploadStatus 和 uploadMessage 状态
4. 优化了UI显示，将上传状态和结果集成到已上传文件信息区域
5. 保持了控制台打印Coze文件ID的功能

### ✅ 验证结果
- ✅ Coze上传功能已成功集成到现有上传流程中
- ✅ 文件选择或URL上传后自动触发Coze上传
- ✅ 用户界面保持简洁，没有新增不必要的按钮
- ✅ 上传状态和结果清晰显示在已上传文件信息区域
- ✅ 控制台正确打印文件ID
- ✅ TypeScript 类型检查通过
- ✅ 开发服务器正常运行 (http://localhost:3003)

---

**文档版本**: v3.0  
**创建时间**: 2025-09-11  
**技术负责人**: 开发团队