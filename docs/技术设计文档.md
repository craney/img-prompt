# ImagePrompt.He 技术设计文档

## 概述

本文档总结了 ImagePrompt.He 项目的技术设计逻辑，整合了产品迭代v1、v2和v3的技术方案和实现。

## 迭代版本历史与技术演进

### v1.0 - 认证系统基础架构重构
**核心变更**：
- 将认证系统从 Clerk 迁移至 NextAuth.js
- 重构数据库连接配置，解决连接字符串问题
- 实现 GitHub OAuth 和 Email Magic Link 认证方式

**技术实现**：

#### 1. 数据库连接重构
**文件**：`packages/db/index.ts`
```
// 修改前
import { createKysely } from "@vercel/postgres-kysely";
export const db = createKysely<DB>();

// 修改后
import { createClient } from "@vercel/postgres";
import { Kysely, PostgresDialect } from "kysely";

const client = createClient({
  connectionString: process.env.POSTGRES_URL,
});

export const db = new Kysely<DB>({
  dialect: new PostgresDialect({
    pool: client as any,
  }),
});
```

#### 2. NextAuth 配置实现
**新增文件**：`packages/auth/nextauth.ts`
```
import { NextAuthOptions } from "next-auth";
import { KyselyAdapter } from "@auth/kysely-adapter";
import GitHubProvider from "next-auth/providers/github";
import EmailProvider from "next-auth/providers/email";

export const authOptions: NextAuthOptions = {
  session: { strategy: "jwt" },
  pages: { signIn: "/login" },
  adapter: KyselyAdapter(db),
  providers: [
    GitHubProvider({
      clientId: env.GITHUB_CLIENT_ID,
      clientSecret: env.GITHUB_CLIENT_SECRET,
    }),
    EmailProvider({
      sendVerificationRequest: async ({ identifier, url }) => {
        // Resend 邮件发送逻辑
      },
    }),
  ],
  callbacks: {
    session({ token, session }) {
      // 会话回调处理
    },
    async jwt({ token, user }) {
      // JWT 令牌处理
    },
  },
};
```

#### 3. tRPC 认证上下文迁移
**文件**：`packages/api/src/trpc.ts`
```
// 修改前
import {auth, currentUser, getAuth} from "@clerk/nextjs/server";
type AuthObject = ReturnType<typeof getAuth>;

// 修改后
import { getToken } from "next-auth/jwt";

export const createTRPCContext = async (opts: {
  headers: Headers;
  req?: NextRequest;
}) => {
  const token = opts.req ? await getToken({ req: opts.req }) : null;
```

### v2.0 - 首页与品牌设计实现
**核心变更**：
- 复刻 https://imageprompt.org/ 首页设计
- 建立统一的品牌形象和视觉规范
- 实现响应式页面布局和国际化支持

**技术实现**：

#### 1. 组件架构设计
```
// apps/nextjs/src/app/[lang]/(marketing)/page.tsx
export default async function ImagePromptHomePage({
  params: { lang },
}: {
  params: { lang: Locale };
}) {
  const dict = await getDictionary(lang);
  
  return (
    <>
      {/* SEO Metadata */}
      <Metadata 
        title={dict.imageprompt.meta.title}
        description={dict.imageprompt.meta.description}
      />
      
      {/* Hero Section */}
      <ImagePromptHeroSection dict={dict.imageprompt.hero} />
      
      {/* Features Grid */}
      <ImagePromptFeaturesGrid 
        features={dict.imageprompt.features}
        interested={dict.imageprompt.interested}
      />
      
      {/* Tools Suite */}
      <ImagePromptToolsSuite dict={dict.imageprompt.tools} />
    </>
  );
}
```

#### 2. 核心组件实现

**HeroSection 组件**:
```
// apps/nextjs/src/components/imageprompt/hero-section.tsx
import { ColourfulText } from "@saasfly/ui/colorful-text";
import { Button } from "@saasfly/ui/button";

interface ImagePromptHeroSectionProps {
  dict: {
    title_prefix: string;
    title_highlight: string;
    subtitle: string;
    cta_primary: string;
    cta_secondary: string;
  };
}

export function ImagePromptHeroSection({ dict }: ImagePromptHeroSectionProps) {
  return (
    <section className="relative w-full py-12 md:py-24 lg:py-32 xl:py-48">
      <div className="container px-4 md:px-6">
        <div className="flex flex-col items-center space-y-4 text-center">
          <div className="space-y-2">
            <h1 className="text-3xl font-bold tracking-tighter sm:text-4xl md:text-5xl lg:text-6xl">
              {dict.title_prefix}{" "}
              <ColourfulText text={dict.title_highlight} />
            </h1>
            <p className="mx-auto max-w-[700px] text-gray-500 md:text-xl dark:text-gray-400">
              {dict.subtitle}
            </p>
          </div>
          <div className="space-x-4">
            <Button>{dict.cta_primary}</Button>
            <Button variant="outline">{dict.cta_secondary}</Button>
          </div>
        </div>
      </div>
    </section>
  );
}
```

#### 3. 国际化内容扩展
```
{
  "imageprompt": {
    "meta": {
      "title": "ImagePrompt.org - Create Better AI Art",
      "description": "Inspire ideas, Enhance image prompt, Create masterpieces"
    },
    "hero": {
      "title_prefix": "Create Better AI Art with",
      "title_highlight": "Image Prompt", 
      "subtitle": "Inspire ideas, Enhance image prompt, Create masterpieces",
      "cta_primary": "Try it now!",
      "cta_secondary": "Tutorials"
    },
    "features": [
      {
        "id": "image_to_prompt",
        "title": "Image to Prompt",
        "description": "Convert Image to Prompt to generate your own image",
        "icon": "Image"
      },
      {
        "id": "magic_enhance", 
        "title": "Magic Enhance",
        "description": "Transform simple text into detailed, descriptive image prompt",
        "icon": "Wand2"
      },
      {
        "id": "ai_describe",
        "title": "AI Describe Image",
        "description": "Let AI help you understand and analyze any image in detail", 
        "icon": "Eye"
      },
      {
        "id": "ai_generator",
        "title": "AI Image Generator", 
        "description": "Transform your image prompt into stunning visuals with AI-powered generation",
        "icon": "Sparkles"
      }
    ]
  }
}
```

### v3.0 - Image to Prompt 核心功能页面实现
**核心变更**：
- 实现Image to Prompt核心功能页面
- 支持多种上传方式
- 实现文件格式验证和大小限制
- 实现多语言支持

**技术实现**：

#### 1. 组件架构设计
```
apps/nextjs/src/app/[lang]/(tools)/
├── image-to-prompt/
│   ├── page.tsx                      # 主页面
│   ├── loading.tsx                   # 加载状态
│   ├── error.tsx                     # 错误处理
│   └── components/
│       ├── image-upload-section.tsx  # 上传区域
│       ├── image-preview-section.tsx # 预览区域
│       ├── feature-tabs.tsx          # 功能切换
│       ├── model-selection.tsx       # AI模型选择
│       ├── language-selector.tsx     # 语言选择器
│       └── prompt-generator.tsx      # 提示词生成组件
```

#### 2. 组件实现

**ImageToPromptPage 组件**:
```
// apps/nextjs/src/app/[lang]/(tools)/image-to-prompt/page.tsx
import { generateMetadata } from "@/app/[lang]/(tools)/image-to-prompt/metadata";
import { ImageToPromptClient } from "@/app/[lang]/(tools)/image-to-prompt/client";

export default ImageToPromptClient;

export { generateMetadata };

```

**ImageToPromptClient 组件**:
```
// apps/nextjs/src/app/[lang]/(tools)/image-to-prompt/client.tsx
import { useState } from "react";
import { Icons } from "@saasfly/ui/icons";
import { Button } from "@saasfly/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@saasfly/ui/tabs";
import { Separator } from "@saasfly/ui/separator";

import { ImageToPromptHeader } from "@/app/[lang]/(tools)/image-to-prompt/components/image-to-prompt-header";
import { FeatureTabs } from "@/app/[lang]/(tools)/image-to-prompt/components/feature-tabs";
import { ImageUploadSection } from "@/app/[lang]/(tools)/image-to-prompt/components/image-upload-section";
import { ImagePreviewSection } from "@/app/[lang]/(tools)/image-to-prompt/components/image-preview-section";
import { ModelSelection } from "@/app/[lang]/(tools)/image-to-prompt/components/model-selection";
import { PromptGenerator } from "@/app/[lang]/(tools)/image-to-prompt/components/prompt-generator";

export function ImageToPromptClient() {
  const [file, setFile] = useState<File | null>(null);
  const [model, setModel] = useState<string>("general");
  const [language, setLanguage] = useState<string>("english");

  return (
    <div className="container mx-auto px-4 py-8">
      <ImageToPromptHeader />
      <FeatureTabs />
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <ImageUploadSection
          file={file}
          setFile={setFile}
          model={model}
          language={language}
        />
        <ImagePreviewSection file={file} />
      </div>
      <Separator className="my-4" />
      <ModelSelection model={model} setModel={setModel} />
      <PromptGenerator language={language} setLanguage={setLanguage} />
    </div>
  );
}

```


## 系统架构设计

### 整体架构
```
apps/nextjs/src/app/[lang]/(tools)/
├── image-to-prompt/
│   ├── page.tsx                      # 主页面
│   ├── loading.tsx                   # 加载状态
│   ├── error.tsx                     # 错误处理
│   └── components/
│       ├── image-upload-section.tsx  # 上传区域
│       ├── image-preview-section.tsx # 预览区域
│       ├── feature-tabs.tsx          # 功能切换
│       ├── model-selection.tsx       # AI模型选择
│       ├── language-selector.tsx     # 语言选择器
│       └── prompt-generator.tsx      # 提示词生成组件
```

### 组件架构
```
ImageToPromptPage (服务端组件) 
├── generateMetadata (SEO元数据)
└── ImageToPromptClient (客户端组件)
    ├── ImageToPromptHeader
    ├── FeatureTabs
    ├── 双栏布局
    │   ├── ImageUploadSection
    │   └── ImagePreviewSection
    ├── ModelSelection
    └── PromptGenerator
```

## 核心设计逻辑

### 1. 状态管理策略
- **上传状态**: `useState<File | null>(null)`
- **模型选择**: `useState<string>("general")`
- **语言选择**: `useState<string>("english")`
- **组件通信**: 通过props回调函数传递状态

### 2. 文件上传设计
支持多种上传方式：
- 拖拽上传
- 文件选择上传
- URL上传

验证机制：
- 文件格式验证 (PNG, JPG, WEBP)
- 文件大小限制 (5MB)
- URL有效性检查

### 3. UI/UX 设计规范

#### 色彩系统
- **主色调**: 紫色系 (#8B5CF6, #7C3AED, #6D28D9)
- **状态色彩**:
  - 激活状态: `border-purple-500 bg-purple-50`
  - 悬停状态: `hover:border-purple-400`
  - 文字色彩: `text-purple-600`

#### 布局规范
- **容器**: `container mx-auto px-4 py-8`
- **网格**: `grid grid-cols-1 lg:grid-cols-2 gap-8`
- **卡片间距**: `gap-4` (模型选择区域)
- **内边距**: `p-4, p-8` (根据组件大小)

#### 交互动画
- **过渡时间**: `transition-all duration-200`
- **悬停效果**: `hover:shadow-md`
- **拖拽反馈**: 边框颜色和背景色变化

### 4. 国际化设计
使用字典文件结构管理多语言内容：
```
{
  "imageToPrompt": {
    "meta": {
      "title": "Free Image to Prompt Generator - ImgPrompt.He",
      "description": "Convert images to detailed AI prompts. Upload your image and generate optimized prompts for Flux, Midjourney, Stable Diffusion and more."
    },
    "header": {
      "title": "Free Image to Prompt Generator",
      "subtitle": "Convert Image to Prompt to generate your own image"
    },
    "tabs": {
      "imageToPrompt": "Image to Prompt",
      "textToPrompt": "Text to Prompt"
    },
    "upload": {
      "dragText": "Upload a photo or drag and drop",
      "formatText": "PNG, JPG, or WEBP up to 5MB",
      "uploadButton": "Upload Image",
      "urlPlaceholder": "Input Image URL"
    },
    "preview": {
      "title": "Image Preview",
      "placeholder": "Your image will show here"
    },
    "models": {
      "general": {
        "title": "General Image Prompt",
        "description": "Natural language description of the image"
      },
      "flux": {
        "title": "Flux",
        "description": "Optimized for state-of-the-art Flux AI models, concise natural language"
      },
      "midjourney": {
        "title": "Midjourney", 
        "description": "Tailored for Midjourney generation with Midjourney parameters"
      },
      "stableDiffusion": {
        "title": "Stable Diffusion",
        "description": "Formatted for Stable Diffusion models"
      }
    },
    "generator": {
      "languageLabel": "Prompt Language:",
      "generateButton": "Generate Prompt",
      "languages": {
        "english": "English",
        "chinese": "中文",
        "japanese": "日本語",
        "korean": "한국어"
      }
    }
  }
}
```

### 5. 响应式设计
采用网格布局系统：
- 移动端: 单列布局
- 桌面端: 双列布局
- 平板端: 自适应布局

### 6. 性能优化策略
- **代码分割**: 组件级别分割
- **图标复用**: 扩展现有图标系统
- **样式复用**: 100%复用现有UI组件
- **类型安全**: 完整TypeScript支持

## 对外接口交互设计

### 1. Coze文件上传接口
- **接口地址**: `https://api.coze.cn/v1/files/upload`
- **请求方法**: POST
- **请求头**:
  ```
  Authorization: Bearer ${COZE_API_TOKEN}
  Content-Type: multipart/form-data
  ```
- **请求参数**:
  ```typescript
  interface CozeFileUploadRequest {
    file: File; // 上传的图片文件
  }
  ```
- **响应数据**:
  ```typescript
  interface CozeFileUploadResponse {
    code: number;        // 状态码，0表示成功
    msg: string;         // 状态消息
    data: {
      file_id: string;   // 文件ID，用于后续操作
      file_url: string;  // 文件访问URL
    };
  }
  ```
- **功能**: 上传图片文件到Coze平台并获取fileId
- **安全措施**: 访问令牌存储在环境变量中，不在前端暴露

### 2. Coze工作流调用接口
- **接口地址**: `https://api.coze.cn/v1/workflow/run`
- **请求方法**: POST
- **请求头**:
  ```
  Authorization: Bearer ${COZE_API_TOKEN}
  Content-Type: application/json
  Accept: application/json
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
  ```
- **请求参数**:
  ```typescript
  interface CozeWorkflowRunRequest {
    workflow_id: "7548376142701658148"; // 固定的工作流ID
    parameters: {
      img: {
        file_id: string;     // 上传文件获得的fileId
      };
      promptType: string;    // 提示词类型 (Normal, Flux, Midjourney, StableDiffusion)
    };
  }
  ```
- **响应数据**:
  ```typescript
  interface CozeWorkflowRunResponse {
    code: number;           // 状态码，0表示成功
    msg: string;            // 状态消息
    data: string;           // JSON字符串，需要进一步解析
    debug_url?: string;     // 调试URL
  }
  
  // data字段解析后的结构示例
  interface CozeWorkflowData {
    prompt: string;         // 生成的提示词结果
    // 其他可能的字段
  }
  ```
- **功能**: 根据用户选择的模型和上传的fileId生成提示词
- **参数映射**:
  - General Image Prompt → Normal
  - Flux → Flux
  - Midjourney → Midjourney
  - Stable Diffusion → StableDiffusion

### 3. 内部API路由设计
```
apps/nextjs/src/app/api/
├── coze/
│   ├── upload/
│   │   └── route.ts     # Coze文件上传API路由
│   └── workflow/
│       └── route.ts     # Coze工作流调用API路由
```

#### 内部Coze文件上传API
- **路由路径**: `/api/coze/upload`
- **请求方法**: POST
- **请求参数**:
  ```typescript
  interface InternalCozeUploadRequest {
    image: File; // 前端传递的图片文件
  }
  ```
- **响应数据**:
  ```typescript
  interface InternalCozeUploadResponse {
    success: boolean;     // 上传是否成功
    fileId?: string;      // 文件ID (成功时)
    errorMessage?: string;// 错误信息 (失败时)
  }
  ```

#### 内部Coze工作流调用API
- **路由路径**: `/api/coze/workflow`
- **请求方法**: POST
- **请求参数**:
  ```typescript
  interface InternalCozeWorkflowRequest {
    fileId: string;         // 文件ID
    promptType: string;     // 提示词类型
  }
  ```
- **响应数据**:
  ```typescript
  interface InternalCozeWorkflowResponse {
    success: boolean;       // 调用是否成功
    prompt?: string;        // 生成的提示词 (成功时)
    debugUrl?: string;      // 调试URL (成功时)
    errorMessage?: string;  // 错误信息 (失败时)
  }
  ```

## 遇到的问题及解决方案

### 1. 页面访问权限问题 (v3.0.1)
**问题描述**: Image to Prompt页面默认需要登录才能访问，影响用户体验。

**解决方案**: 
- 修改 `apps/nextjs/src/utils/nextauth.ts` 文件
- 将 `/image-to-prompt` 路径添加到公共路由列表中
- 保持与其他公共页面（如pricing、docs）一致的访问方式

**安全考虑**:
- 仅开放了工具使用页面，不涉及用户数据或敏感功能
- 实际的AI服务调用可以根据需要添加限流或其他保护措施

### 2. 字典访问路径错误 (v3.0.2)
**问题描述**: 页面字典访问路径错误，导致页面无法正常显示内容。

**解决方案**:
- 修复 `apps/nextjs/src/app/[lang]/(tools)/image-to-prompt/page.tsx` 中的字典访问路径
- 将 `dict.imageToPrompt.meta.title` 修改为 `dict.imageprompt.imageToPrompt.meta.title`

### 3. Icons组件导入方式错误 (v3.0.2)
**问题描述**: Icons组件导入方式不正确，导致图标无法正常显示。

**解决方案**:
- 将 `import { Icons } from "@saasfly/ui/icons"` 修改为 `import * as Icons from "@saasfly/ui/icons"`
- 修复了多个相关组件文件中的导入方式

### 4. Coze API地址确认 (v3.0.4)
**问题描述**: 用户反馈Coze API域名可能不正确。

**解决方案**:
- 确认Coze API的正确域名为 `api.coze.cn`
- 检查代码中使用的API地址已经是正确的 `https://api.coze.cn/v1/files/upload`
- 无需进行代码修改

### 5. 工作流调用集成 (v3.0.5)
**问题描述**: 需要集成Coze工作流调用功能，根据用户选择的模型生成提示词。

**解决方案**:
- 创建后端API路由处理Coze工作流调用
- 在前端组件中调用新的后端API
- 根据用户选择的模型传递对应的promptType参数
- 安全地管理Coze访问令牌，存储在环境变量中

## API 设计

### 环境变量需求
```bash
# AI服务配置
NEXT_PUBLIC_AI_SERVICE_URL=
AI_SERVICE_API_KEY=

# 文件存储配置
NEXT_PUBLIC_UPLOAD_BUCKET=
UPLOAD_SERVICE_KEY=

# 图片处理配置
IMAGE_RESIZE_QUALITY=80
IMAGE_MAX_SIZE=5242880  # 5MB

# Coze平台配置
COZE_API_TOKEN=your_coze_api_token
COZE_WORKFLOW_ID=7548376142701658148
```

### 后端服务需求
1. **文件上传API**
   - 文件存储服务
   - 图片格式转换
   - 文件安全检查

2. **图片分析API**
   - AI图片识别服务
   - 多模型支持
   - 提示词生成

## 安全设计

### 访问控制
- 页面设置为公共访问，无需登录即可使用
- 保持与其他公共页面（如pricing、docs）一致的访问方式

### 数据安全
- 文件格式验证
- 文件大小限制
- 图片安全检查
- API令牌安全存储在环境变量中

### API路由安全
- Coze相关API路由不进行登录验证
- 访问令牌存储在环境变量中，不在前端暴露
- 错误处理和日志记录

## 部署考虑

### CDN配置
- 静态资源缓存
- 图片优化配置
- 上传文件的临时存储

## 测试策略

### 单元测试
- 文件上传组件测试
- 图片预览组件测试
- 模型选择组件测试
- 表单验证测试

### 集成测试
- 端到端上传流程测试
- AI服务调用测试
- 多语言切换测试
- 响应式布局测试

### 性能测试
- 文件上传性能测试
- 大图片处理测试
- 并发请求测试
- 内存泄漏测试