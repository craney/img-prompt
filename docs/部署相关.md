# ImagePrompt.He 部署指南

本文档总结了 ImagePrompt.He 项目在 Vercel 平台部署过程中的经验教训和最佳实践。
## 问题现象

在部署应用到 Vercel 平台时，遇到了以下关键问题：

1. **数据收集失败错误**：`/[lang]/dashboard/billing` 页面在构建过程中数据收集失败，导致整体部署失败
2. **类型错误**：`packages/auth/nextauth.ts` 文件中存在多个 TypeScript 类型错误
3. **配置错误**：`vercel.json` 文件缺少正确的输出目录配置

## 根本原因分析

1. **外部服务依赖**：原始的计费页面依赖 Stripe 等外部服务，在部署环境中无法获取数据
2. **API 密钥缺失**：Resend 服务的 API 密钥缺失，但代码中未处理这种情况，导致运行时错误
3. **类型安全问题**：环境变量可能为 `undefined`，但代码中多处需要明确的 `string` 类型
4. **部署配置不正确**：Vercel 无法找到正确的输出目录

## 解决方案

### 1. 简化计费页面

修改了 `apps/nextjs/src/app/[lang]/(dashboard)/dashboard/billing/page.tsx` 文件，将其改为完全静态的内容：
- 移除了所有外部组件依赖
- 删除了与 Stripe 等服务的集成代码
- 使用纯 HTML 和内联样式展示静态信息
- 显示 Demo Plan 和有效期信息

### 2. 修复认证模块类型错误

更新了 `packages/auth/nextauth.ts` 文件，主要修改包括：

- **添加类型安全辅助函数**：创建 `getEnv` 函数确保环境变量有明确类型
  ```typescript
  // 辅助函数：确保环境变量存在
  const getEnv = (key: string, value: string | undefined): string => {
    if (!value) {
      throw new Error(`${key} is required but not provided`);
    }
    return value;
  };
  ```

- **完善接口定义**：正确定义 `JWT` 接口，添加缺失的 `id` 字段

- **优化空值处理**：在 `session` 和 `jwt` 回调函数中添加严格的空值检查和默认值

- **使用条件加载**：只有在同时提供了 `RESEND_FROM` 和 `RESEND_API_KEY` 时才初始化 `EmailProvider`

- **动态导入**：将 Resend 相关代码改为动态导入模式，避免不必要的依赖加载

### 3. 修正 Vercel 配置

更新了 `vercel.json` 文件，添加了正确的输出目录配置：

**最终正确的配置**：
```json
{
  "github": {
    "silent": true
  },
  "buildCommand": "turbo run build --filter=@saasfly/nextjs",
  "installCommand": "bun install",
  "outputDirectory": "apps/nextjs/.next",
  "framework": "nextjs"
}
```

**关键配置说明**：
- `buildCommand`: 使用 Turbo 构建指定的 Next.js 应用
- `installCommand`: 使用 Bun 作为包管理器
- `outputDirectory`: 指定构建输出目录为 Next.js 应用的 `.next` 目录
- `framework`: 明确指定为 Next.js 框架

## 验证结果

- **本地构建**：`bun run build` 命令成功执行，退出码为 0
- **Vercel 部署**：`vercel --prod` 命令成功执行，退出码为 0
- **生产环境**：应用已成功部署到 Vercel 平台，访问地址：https://img-prompt.vercel.app

## 经验总结

### 基础部署原则

1. **简化关键页面**：对于可能因外部依赖导致部署失败的页面，应尽量简化或使用静态内容
2. **类型安全优先**：为所有环境变量添加明确的类型检查和错误处理
3. **条件加载**：使用条件加载和动态导入技术，避免不必要的依赖加载
4. **配置准确性**：确保部署配置文件中的路径和参数正确无误
5. **本地验证**：在部署前先在本地运行构建命令验证代码正确性

### 2025年9月部署踩坑经验

#### 问题概述
在本次部署过程中，花费了大量时间解决实际上不存在的问题，主要原因是对 Vercel 项目管理机制理解不够，以及在错误的配置上反复调试。

#### 主要问题和解决方案

**1. 项目识别混乱** (最主要原因)
- **问题表现**: 一直在部署到错误的 `nextjs` 项目，而不是正确的 `img-prompt` 项目
- **根本原因**: Vercel 账户下有多个项目，CLI 默认选择了错误的项目进行部署
- **项目标识**: 通过 `.vercel/project.json` 确认当前目录对应的项目
- **解决方法**: 
  ```bash
  vercel projects list  # 查看所有项目
  vercel projects inspect img-prompt  # 查看项目详情
  ```

**2. workspace 协议依赖问题** (误判问题)
- **问题表现**: 持续出现 `npm error Unsupported URL Type "workspace:": workspace:*`
- **实际情况**: `img-prompt` 项目已经正确配置了 `bun install`，不需要额外处理
- **经验教训**: 在修改配置前，先检查项目是否已经有正确的配置
- **正确理解**: workspace 依赖是 monorepo 的标准做法，需要 Turbo 来处理

**3. 环境变量配置混乱** (过度配置)
- **问题表现**: 在错误的 `nextjs` 项目中设置了大量不必要的环境变量
- **尝试的无效配置**: `USE_BUN`、`VERCEL_BUN`、`VERCEL_FORCE_BUN` 等
- **实际情况**: `img-prompt` 项目已经有所有必需的环境变量
- **关键认识**: Bun 已经在 `package.json` 中指定为包管理器，无需额外配置

**4. 构建命令配置问题** (重复劳动)
- **问题表现**: 在错误的 `nextjs` 项目中反复修改 `vercel.json`
- **尝试的配置**: 
  - `bun run build:web`
  - `cd apps/nextjs && bun run build`  # ❌ 错误：无法解析 workspace 依赖
  - `turbo run build --filter=@saasfly/nextjs`  # ✅ 正确
- **根因分析**: 
  - `cd apps/nextjs && bun run build` 会失败，因为无法解析 `workspace:*` 依赖
  - 必须在根目录运行，让 Turbo 处理依赖关系
- **实际情况**: `img-prompt` 项目已经有正确的配置

#### 技术原理澄清

**Monorepo 构建机制**：
```bash
# ❌ 错误的方式（在子目录运行）
cd apps/nextjs && bun run build
# 问题：找不到 workspace 依赖，因为 workspace 配置在根目录

# ✅ 正确的方式（在根目录运行）
turbo run build --filter=@saasfly/nextjs
# Turbo 自动处理依赖关系和构建顺序
```

**依赖解析顺序**：
```
@saasfly/nextjs 依赖：
├── @saasfly/api ← 先构建
├── @saasfly/auth ← 先构建  
├── @saasfly/db ← 先构建
├── @saasfly/ui ← 先构建
└── @saasfly/nextjs ← 最后构建
```

#### 正确的部署流程

1. **确认项目对应关系**
   ```bash
   # 检查当前目录链接的项目
   cat .vercel/project.json
   # 应该显示：{"projectId":"prj_VtI90m4dMZNO5wvlB0aAsBtaFVP8","orgId":"team_6dCUTtV1im8uUQ6I0yy7qFHz","projectName":"img-prompt"}
   
   # 查看所有项目
   vercel projects list
   ```

2. **检查现有配置**
   ```bash
   # 检查 Vercel 配置
   cat vercel.json
   # 应该有正确的 turbo build 命令
   
   # 检查环境变量
   vercel env ls
   ```

3. **验证本地构建**
   ```bash
   # 在根目录运行
   bun run build  # 构建所有包
   bun run build:web  # 只构建 Next.js 应用
   ```

4. **执行部署**
   ```bash
   # 确保在正确的项目目录
   vercel --prod  # 部署到 img-prompt 项目
   ```

#### 关键经验总结

1. **项目识别优先**: 
   - 部署前先检查 `.vercel/project.json` 确认项目对应关系
   - 使用 `vercel projects list` 了解所有可用项目

2. **Monorepo 构建原理**:
   - 理解 workspace 依赖需要在根目录解析
   - Turbo 是 monorepo 的核心构建工具
   - 不要在子目录中直接运行构建命令

3. **配置检查原则**:
   - 在修改配置前，先检查项目是否已经有正确的配置
   - 避免在错误的项目上设置环境变量
   - 最小化修改，很多时候现有配置已经正确

4. **工具使用正确性**:
   - Bun 已经在 package.json 中指定，无需额外配置
   - Turbo 自动处理依赖关系，不需要手动管理
   - 理解各个工具的职责分工

#### 最终配置状态

**当前正确的配置**：
- **项目链接**: `.vercel/project.json` 指向 `img-prompt` 项目
- **构建配置**: `vercel.json` 使用 turbo 构建命令
- **包管理器**: Bun (在 package.json 中指定)
- **环境变量**: 所有必需的环境变量已配置
- **部署命令**: `vercel --prod` (无需额外参数)

**简化的部署流程**：
```bash
# 一键部署（所有配置都已正确）
vercel --prod
```

#### 重要教训

1. **先诊断，再治疗**: 在解决问题之前，先确认问题是否存在
2. **理解原理**: 深入理解 monorepo、workspace、Turbo 的工作原理
3. **最小干预**: 很多时候项目已经有正确的配置，不需要额外修改
4. **文档记录**: 及时记录部署过程和经验教训，避免重复踩坑

这个案例体现了"问题可能不在技术本身，而在对工具和流程的理解上"的重要性。

---

## 附录：关键技术概念

### Vercel 项目管理机制

**项目识别优先级**：
1. `.vercel/project.json` (最高优先级)
2. 当前目录名称匹配
3. CLI 交互选择

**项目链接机制**：
```bash
# 查看当前链接的项目
cat .vercel/project.json

# 重新链接项目
vercel --scope <team-name> --project <project-name>
```

### Monorepo 构建原理

**Workspace 依赖解析**：
- `workspace:*` 表示引用本地包
- 必须在根目录解析 workspace 配置
- Turbo 自动处理依赖关系和构建顺序

**构建命令对比**：
```bash
# ❌ 错误：无法解析 workspace 依赖
cd apps/nextjs && bun run build

# ✅ 正确：Turbo 处理依赖关系
turbo run build --filter=@saasfly/nextjs
```

### 工具职责分工

**Bun**: 包管理器
- 依赖安装：`bun install`
- 脚本执行：`bun run <script>`
- 已在 package.json 中指定为包管理器

**Turbo**: Monorepo 构建工具
- 依赖分析：自动解析包间依赖
- 构建优化：并行构建、缓存机制
- 任务管理：按正确顺序执行构建

**Vercel**: 部署平台
- 项目管理：通过 `.vercel/project.json` 识别项目
- 构建执行：根据 `vercel.json` 配置执行构建
- 环境管理：管理部署环境和变量

### 常见命令参考

**开发环境**：
```bash
# 启动开发服务器
bun run dev:web
# 实际执行：turbo dev --parallel --filter !stripe
```

**构建命令**：
```bash
# 构建所有包
bun run build
# 实际执行：turbo build

# 只构建 Next.js 应用
bun run build:web  
# 实际执行：turbo run build --filter=@saasfly/nextjs
```

**部署命令**：
```bash
# 部署到生产环境
vercel --prod
```

### 故障排除清单

**部署前检查**：
- [ ] 确认 `.vercel/project.json` 指向正确的项目
- [ ] 检查 `vercel.json` 配置是否正确
- [ ] 验证本地构建是否成功
- [ ] 确认所有必需的环境变量已配置

**构建失败排查**：
- [ ] 检查是否在根目录运行构建命令
- [ ] 确认使用的是 Turbo 构建命令
- [ ] 验证 workspace 依赖是否正确解析
- [ ] 检查 Node.js 版本兼容性

**部署后验证**：
- [ ] 检查部署日志是否正常
- [ ] 验证应用是否可以正常访问
- [ ] 测试关键功能是否正常工作
- [ ] 确认环境变量是否正确加载

### 相关文件说明

**配置文件**：
- `.vercel/project.json`: Vercel 项目链接信息
- `vercel.json`: Vercel 构建配置
- `package.json`: 项目依赖和脚本配置
- `turbo.json`: Turbo 构建管道配置

**临时文件**（可删除）：
- `package.json.vercel`: Vercel 部署时生成的临时文件
- `.vercel/local`: Vercel 本地开发配置

**Git 忽略文件**：
```
.vercel
*.vercel
.next
.env.local
```